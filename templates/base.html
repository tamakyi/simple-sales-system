<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %} {{ app_title }} {% endblock %}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://cdnjs.snrat.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css" rel="stylesheet">
    {% if analyze_enable and analyzer_script %} {{ analyzer_script|safe }} {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        {% if background_image_url %}
        :root {
            --bg-image: url('{{ background_image_url }}');
            --bg-opacity: {{ background_opacity }};
            --bg-size: {{ background_size }};
        }
        {% endif %}
        
        /* 消息自动消失动画 */
        .alert-auto-dismiss {
            transition: opacity 0.5s ease-in-out;
        }
        
        .alert-fade-out {
            opacity: 0;
        }
    </style>
    {% block head %}{% endblock %}
</head>
<body class="{% if background_image_url %}background-image{% endif %}">
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">{{ app_title }}</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/products">商品管理</a></li>
                <li class="nav-item"><a class="nav-link" href="/sales">销售管理</a></li>
                <li class="nav-item"><a class="nav-link" href="/sales-simple">简易销售</a></li>
                <li class="nav-item"><a class="nav-link" href="/categories">分类管理</a></li>
                {% if current_user.is_authenticated and current_user.is_admin %}
                <li class="nav-item"><a class="nav-link" href="/users">用户管理</a></li>
                <li class="nav-item"><a class="nav-link" href="/logs">操作日志</a></li>
                {% endif %}
                <li class="nav-item"><a class="nav-link" href="/export">导出报表</a></li>
            </ul>
            {% if current_user.is_authenticated %}
            <span class="navbar-text me-2">用户：{{ current_user.username }}{% if current_user.is_admin %} 
                <span class="badge bg-danger">管理员</span>{% endif %}</span>
            <a class="btn btn-outline-danger btn-sm" href="/logout">退出</a>
            {% endif %}
        </div>
    </div>
</nav>
<div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show alert-auto-dismiss" role="alert" data-auto-dismiss="5000">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
</div>
<script src="https://cdnjs.snrat.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js"></script>

<script>
// 消息自动消失功能
document.addEventListener('DOMContentLoaded', function() {
    // 获取所有需要自动消失的消息
    const autoDismissAlerts = document.querySelectorAll('.alert-auto-dismiss[data-auto-dismiss]');
    
    autoDismissAlerts.forEach(function(alert) {
        const dismissTime = parseInt(alert.getAttribute('data-auto-dismiss'));
        
        // 设置定时器，在指定时间后消失
        setTimeout(function() {
            // 添加淡出动画类
            alert.classList.add('alert-fade-out');
            
            // 动画结束后移除元素
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 500); // 等待淡出动画完成
        }, dismissTime);
    });
    
    // 为所有消息添加点击关闭功能（增强用户体验）
    const allAlerts = document.querySelectorAll('.alert');
    allAlerts.forEach(function(alert) {
        alert.addEventListener('click', function() {
            this.classList.add('alert-fade-out');
            setTimeout(() => {
                if (this.parentNode) {
                    this.parentNode.removeChild(this);
                }
            }, 500);
        });
    });
});

// 可选：添加全局消息控制函数
window.dismissAlert = function(alertElement) {
    if (alertElement) {
        alertElement.classList.add('alert-fade-out');
        setTimeout(() => {
            if (alertElement.parentNode) {
                alertElement.parentNode.removeChild(alertElement);
            }
        }, 500);
    }
};

// 可选：添加手动显示消息的函数（用于动态添加消息）
window.showFlashMessage = function(message, category = 'success', autoDismiss = true) {
    const alertClass = category === 'error' ? 'alert-danger' : 'alert-success';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show alert-auto-dismiss" role="alert" ${autoDismiss ? 'data-auto-dismiss="5000"' : ''}>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    const container = document.querySelector('.container.mt-3');
    if (container) {
        // 在现有消息之后插入新消息
        const existingAlerts = container.querySelectorAll('.alert');
        if (existingAlerts.length > 0) {
            existingAlerts[existingAlerts.length - 1].insertAdjacentHTML('afterend', alertHtml);
        } else {
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
        
        // 如果启用了自动消失，设置定时器
        if (autoDismiss) {
            setTimeout(() => {
                const newAlert = container.querySelector('.alert:last-child');
                if (newAlert) {
                    dismissAlert(newAlert);
                }
            }, 5000);
        }
    }
};
</script>

</body>
</html>