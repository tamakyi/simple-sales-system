{% extends 'base.html' %}
{% block title %}操作日志{% endblock %}
{% block content %}
<div class="container">
    <h2 class="my-4">操作日志</h2>
    
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">系统操作记录</h5>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 logs-table">
                    <thead class="table-light">
                        <tr>
                            <th width="160">时间</th>
                            <th width="120">操作人</th>
                            <th>操作内容</th>
                            <th width="100">状态</th>
                            <th width="100">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs.items %}
                        <tr class="log-row">
                            <td data-label="时间" class="align-middle">{{ log.ts.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td data-label="操作人" class="align-middle">{{ log.user.username }}</td>
                            <td data-label="操作内容" class="align-middle">
                                <div class="log-action-content">
                                    <div class="log-main-action">{{ log.action }}</div>
                                    {% if log.sale %}
                                    <div class="log-sale-details small text-muted mt-1">
                                        {{ log.sale.product.name }} × {{ log.sale.quantity }}
                                        ({{ '进货' if log.sale.type == 'in' else '销售' }})
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="状态" class="align-middle">
                                {% if log.sale and log.sale.is_reversed %}
                                <span class="badge bg-danger">已撤回</span>
                                {% elif log.sale %}
                                <span class="badge bg-success">有效</span>
                                {% else %}
                                <span class="badge bg-secondary">系统操作</span>
                                {% endif %}
                            </td>
                            <td data-label="操作" class="align-middle">
                                {% if log.sale and not log.sale.is_reversed and (current_user.is_admin or current_user.id == log.user_id) %}
                                <form method="post" action="{{ url_for('reverse_sale', sale_id=log.sale.id ) }}" 
                                      onsubmit="return confirm('确定要撤回此操作吗？撤回将恢复库存！');" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-warning btn-sm">撤回</button>
                                </form>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4">暂无日志记录</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 分页导航 -->
    {% if logs.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if logs.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('logs', page=logs.prev_num) }}">上一页</a>
            </li>
            {% endif %}
            
            {% for page_num in logs.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    <li class="page-item {% if page_num == logs.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('logs', page=page_num) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            
            {% if logs.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('logs', page=logs.next_num) }}">下一页</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<style>
    /* 确保表格行高一致 */
    .logs-table tbody tr {
        height: auto;
        min-height: 70px; /* 设置最小行高 */
    }
    
    .logs-table td {
        vertical-align: middle !important; /* 垂直居中 */
        padding: 12px 8px;
    }
    
    /* 操作内容样式 */
    .log-action-content {
        min-height: 40px; /* 确保内容区域有最小高度 */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .log-main-action {
        word-wrap: break-word;
        word-break: break-word;
        line-height: 1.4;
    }
    
    .log-sale-details {
        line-height: 1.3;
    }
    
    /* 表格布局优化 */
    .logs-table {
        table-layout: fixed; /* 固定布局，确保列宽一致 */
    }
    
    .logs-table th:nth-child(3), 
    .logs-table td:nth-child(3) {
        width: auto; /* 操作内容列自动宽度 */
    }
    
    /* 徽章样式优化 */
    .badge {
        font-size: 0.75em;
        padding: 0.4em 0.6em;
    }
    
    /* 按钮样式优化 */
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    /* 表格响应式优化 */
    @media (max-width: 768px) {
        .logs-table {
            table-layout: auto; /* 在小屏幕上使用自动布局 */
        }
        
        .logs-table th,
        .logs-table td {
            width: auto !important;
        }
        
        .log-action-content {
            min-height: auto;
        }
    }
</style>
{% endblock %}