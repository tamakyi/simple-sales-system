{% extends 'base.html' %}
{% block title %}销售管理{% endblock %}
{% block content %}
<h2>销售管理</h2>

<!-- 搜索和筛选表单 -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-2 align-items-center">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-12 col-md-4">
                <input type="text" name="keyword" class="form-control" placeholder="搜索商品名称" value="{{ keyword }}">
            </div>
            <div class="col-12 col-md-3">
                <select name="category_id" class="form-select">
                    <option value="">所有分类</option>
                    {% for cat in cats %}
                    <option value="{{ cat.id }}" {% if category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary w-100">搜索</button>
            </div>
            <div class="col-12 col-md-3 text-md-end">
                <a href="{{ url_for('sales_simple') }}" class="btn btn-outline-secondary btn-sm">查看简化版</a>
            </div>
        </form>
    </div>
</div>

<!-- 按分类显示商品 -->
{% for category_name, product_list in grouped_products.items() %}
<div class="card category-card mb-3">
    <div class="card-header bg-light">
        <h5 class="mb-0">{{ category_name }}</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="sales-table">
                <thead>
                    <tr>
                        <th class="text-center">图片</th>
                        <th class="text-center">商品</th>
                        <th class="text-center">库存</th>
                        <th class="mobile-hidden text-center">历史销售额</th>
                        <th class="mobile-hidden text-center">今日销售额</th>
                        <th class="mobile-hidden text-center">历史销量</th>
                        <th class="text-center">操作</th>
                        <th class="text-center">详情</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in product_list %}
                    <tr>
                        <td class="product-image-cell text-center">
                            {% if product.image %}
                                {% if product.image.startswith('http') %}
                                    <img src="{{ product.image }}" 
                                         class="product-thumbnail" alt="{{ product.name }}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                {% else %}
                                    <img src="{{ url_for('static', filename=product.image) }}" 
                                         class="product-thumbnail" alt="{{ product.name }}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                {% endif %}
                                <div class="no-image-placeholder" style="display: none;">
                                    <span>无图片</span>
                                </div>
                            {% else %}
                                <div class="no-image-placeholder">
                                    <span>无图片</span>
                                </div>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ product.name }}</td>
                        <td class="text-center">{{ product.stock }}</td>
                        <td class="mobile-hidden text-center">{{ stat_map[product.id].all_sale|round(2) }}</td>
                        <td class="mobile-hidden text-center">{{ stat_map[product.id].today_sale|round(2) }}</td>
                        <td class="mobile-hidden text-center">{{ stat_map[product.id].all_qty }}</td>
                        <td class="text-center">
                            <form class="sales-operate-form" method="post" action="{{ url_for('sales_operate', pid=product.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="source_page" value="sales">
                                <div class="input-group input-group-sm">
                                    <input type="number" name="quantity" class="form-control" value="1" min="1" required>
                                    <button type="submit" name="submit_in" class="btn btn-outline-success">进货</button>
                                    <button type="submit" name="submit_out" class="btn btn-outline-primary">销售</button>
                                </div>
                            </form>
                        </td>
                        <td class="text-center">
                            <a href="{{ url_for('sales_detail', pid=product.id) }}" class="btn btn-info btn-sm">详情</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endfor %}

<!-- 分页 -->
{% if products.pages > 1 %}
<nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
        {% if products.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('sales', page=products.prev_num, keyword=keyword, category_id=category_id) }}">上一页</a>
        </li>
        {% endif %}
        
        {% for page_num in products.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                <li class="page-item {% if page_num == products.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('sales', page=page_num, keyword=keyword, category_id=category_id) }}">{{ page_num }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        
        {% if products.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('sales', page=products.next_num, keyword=keyword, category_id=category_id) }}">下一页</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}