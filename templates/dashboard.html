{% extends 'base.html' %}
{% block title %}
    {% if start_date == end_date and start_date == datetime.date.today() %}
        今日仪表盘
    {% elif start_date == end_date %}
        {{ start_date|dateformat('%Y-%m-%d') }}仪表盘
    {% else %}
        {{ start_date|dateformat('%Y-%m-%d') }} 至 {{ end_date|dateformat('%Y-%m-%d') }} 仪表盘
    {% endif %}
{% endblock %}
{% block head %}
<script src="https://cdnjs.snrat.com/ajax/libs/echarts/6.0.0/echarts.min.js"></script>
{% endblock %}
{% block content %}
<!-- 公告展示 -->
{% if announcement_enabled and announcement %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>公告:</strong> {{ announcement }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
<!-- 日期范围选择器 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">选择日期范围查看销售情况</h5>
                <form method="get" class="row g-3 align-items-center">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="col-12 col-md-3">
                        <label for="start_date" class="form-label">开始日期</label>
                        <input type="date" id="start_date" name="start_date" class="form-control" 
                               value="{{ start_date|dateformat('%Y-%m-%d') }}"
                               max="{{ datetime.date.today()|dateformat('%Y-%m-%d') }}">
                    </div>
                    <div class="col-12 col-md-3">
                        <label for="end_date" class="form-label">结束日期</label>
                        <input type="date" id="end_date" name="end_date" class="form-control" 
                               value="{{ end_date|dateformat('%Y-%m-%d') }}"
                               max="{{ datetime.date.today()|dateformat('%Y-%m-%d') }}">
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">查询</button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-info">今天</a>
                            <button type="button" class="btn btn-outline-secondary" id="yesterdayBtn">昨天</button>
                            <button type="button" class="btn btn-outline-secondary" id="last7daysBtn">最近7天</button>
                            <button type="button" class="btn btn-outline-secondary" id="last30daysBtn">最近30天</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3 justify-content-center">
    <div class="col-12 col-md-4 mb-3 dashboard-card">
        <div class="card text-white bg-info h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    {% if start_date == end_date %}
                        {% if start_date == datetime.date.today() %}
                            今日销售额
                        {% else %}
                            {{ start_date|dateformat('%Y-%m-%d') }}销售额
                        {% endif %}
                    {% else %}
                        日期范围销售额
                    {% endif %}
                </h5>
                <p class="card-text fs-4">{{ selected_date_total|round(2) }}</p>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4 mb-3 dashboard-card">
        <div class="card text-white bg-secondary h-100">
            <div class="card-body text-center">
                <h5 class="card-title">昨日销售额</h5>
                <p class="card-text fs-4">{{ yesterday_total|round(2) }}</p>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4 mb-3 dashboard-card">
        <div class="card text-white bg-success h-100">
            <div class="card-body text-center">
                <h5 class="card-title">历史总销售额</h5>
                <p class="card-text fs-4">{{ all_total|round(2) }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12 col-lg-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    {% if start_date == end_date %}
                        {% if start_date == datetime.date.today() %}
                            今日分类销售额占比
                        {% else %}
                            {{ start_date|dateformat('%Y-%m-%d') }}分类销售额占比
                        {% endif %}
                    {% else %}
                        {{ start_date|dateformat('%Y-%m-%d') }} 至 {{ end_date|dateformat('%Y-%m-%d') }} 分类销售额占比
                    {% endif %}
                </h5>
                <div id="cat-sale-pie" style="width:100%;height:300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    {% if start_date == end_date %}
                        {% if start_date == datetime.date.today() %}
                            今日销售排行榜（销售额）
                        {% else %}
                            {{ start_date|dateformat('%Y-%m-%d') }}销售排行榜（销售额）
                        {% endif %}
                    {% else %}
                        {{ start_date|dateformat('%Y-%m-%d') }} 至 {{ end_date|dateformat('%Y-%m-%d') }} 销售排行榜（销售额）
                    {% endif %}
                </h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>商品</th><th>总销售额</th><th class="mobile-hidden">总销量</th></tr>
                        </thead>
                        <tbody>
                            {% for item in sale_ranks %}
                            <tr>
                                <td data-label="商品">{{ item[0] }}</td>
                                <td data-label="总销售额">{{ item[1]|round(2) }}</td>
                                <td class="mobile-hidden" data-label="总销量">{{ item[2] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">
            {% if start_date == end_date %}
                {% if start_date == datetime.date.today() %}
                    今日最近20条销售流水
                {% else %}
                    {{ start_date|dateformat('%Y-%m-%d') }}销售流水
                {% endif %}
            {% else %}
                {{ start_date|dateformat('%Y-%m-%d') }} 至 {{ end_date|dateformat('%Y-%m-%d') }} 销售流水
            {% endif %}
        </h5>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>商品</th>
                        <th>数量</th>
                        <th class="mobile-hidden">金额</th>
                        <th>时间</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in sales %}
                    <tr>
                        <td data-label="商品">{{ s.product.name }}</td>
                        <td data-label="数量">{{ s.quantity }}</td>
                        <td class="mobile-hidden" data-label="金额">{{ s.amount|round(2) }}</td>
                        <td data-label="时间">{{ s.created_at.strftime('%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
var myChart = echarts.init(document.getElementById('cat-sale-pie'));
var option = {
    title: {text: '分类销售额占比', left: 'center', textStyle: {fontSize: 14}},
    tooltip: {
        trigger: 'item',
        formatter: function(params) {
            return params.name + ': ' + params.value.toFixed(2) + ' (' + params.percent + '%)';
        }
    },
    legend: {orient: 'horizontal', bottom: 0, textStyle: {fontSize: 12}},
    series: [{
        name: '销售额',
        type: 'pie',
        radius: '60%',
        data: [
            {% for i in range(cat_names|length) %}
            {value: {{ cat_amounts[i] }}, name: "{{ cat_names[i] }}"}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        label: {
            formatter: function(params) {
                return params.name + ': ' + params.value.toFixed(2) + ' (' + params.percent + '%)';
            }
        }
    }]
};
myChart.setOption(option);

// 响应式调整图表
window.addEventListener('resize', function() {
    myChart.resize();
});

// 快捷日期范围选择
document.getElementById('yesterdayBtn').addEventListener('click', function() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const dateStr = yesterday.toISOString().split('T')[0];
    document.getElementById('start_date').value = dateStr;
    document.getElementById('end_date').value = dateStr;
});

document.getElementById('last7daysBtn').addEventListener('click', function() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 6);
    
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
});

document.getElementById('last30daysBtn').addEventListener('click', function() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 29);
    
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
});

// 日期验证：结束日期不能早于开始日期
document.getElementById('end_date').addEventListener('change', function() {
    const startDate = new Date(document.getElementById('start_date').value);
    const endDate = new Date(this.value);
    
    if (endDate < startDate) {
        alert('结束日期不能早于开始日期');
        this.value = document.getElementById('start_date').value;
    }
});

document.getElementById('start_date').addEventListener('change', function() {
    const startDate = new Date(this.value);
    const endDate = new Date(document.getElementById('end_date').value);
    
    if (endDate < startDate) {
        document.getElementById('end_date').value = this.value;
    }
});
</script>
{% endblock %}